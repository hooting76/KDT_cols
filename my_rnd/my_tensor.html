<!DOCTYPE html>
<html>
<head>
  <title>ë‚ ì”¨ ì˜ˆì¸¡ (TensorFlow.js)</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
</head>
<body>
  <h1>ë‚ ì”¨ ì˜ˆì¸¡ (ì˜¨ë„ + ê°•ìˆ˜í™•ë¥ )</h1>
  <button onclick="trainAndPredict()">í•™ìŠµ ë° ì˜ˆì¸¡</button>
  <div id="output"></div>

  <script>
    async function trainAndPredict() {
        const res = await fetch('weather_data.json');
        const data = await res.json();

        // ì…ë ¥: [day, humidity, rainfall, wind]
        const inputs = data.map(d => [d.day, d.humidity, d.rainfall, d.wind]);

        // ì¶œë ¥: [temperature, rain_chance]
        const labels = data.map(d => [d.temperature, d.rain_chance]);

        const inputTensor = tf.tensor2d(inputs);
        const labelTensor = tf.tensor2d(labels);

        // ëª¨ë¸ ì •ì˜
        const model = tf.sequential();
        model.add(tf.layers.dense({ inputShape: [4], units: 16, activation: 'relu' }));
        model.add(tf.layers.dense({ units: 8, activation: 'relu' }));
        model.add(tf.layers.dense({ units: 2 })); // ì¶œë ¥ 2ê°œ: temperature, rain_chance

        model.compile({
            optimizer: tf.train.adam(),
            loss: 'meanSquaredError'
        });

        await model.fit(inputTensor, labelTensor, {
            epochs: 200,
            callbacks: {
            onEpochEnd: (epoch, logs) => {
                console.log(`Epoch ${epoch}: loss = ${logs.loss}`);
            }
            }
        });

        // ì˜ˆì¸¡: ì˜ˆì‹œ ì…ë ¥ê°’
        const testInput = tf.tensor2d([[8, 47, 0.1, 3.0]]);
        const prediction = model.predict(testInput);

        prediction.array().then(result => {
            const [predictedTemp, predictedRainChance] = result[0];
            document.getElementById('output').innerHTML = `
            <p><strong>8ì¼ì§¸ ì˜ˆì¸¡:</strong></p>
            <p>ğŸŒ¡ ì˜¨ë„: ${predictedTemp.toFixed(2)} Â°C</p>
            <p>ğŸŒ§ ê°•ìˆ˜í™•ë¥ : ${predictedRainChance.toFixed(2)} %</p>
            `;
        });
    };
    </script>

    <script>
        window.onload = () => {

            // í‚¤ í˜¸ì¶œ
            async function svc_yk(svc){
                try {
                    const res_svc_yk    = await fetch(svc);
                    const data          = await res_svc_yk.text();
                    const svc_yk_data   = await JSON.parse(data);

                    return weather_func_wrap(svc_yk_data[0].key);
                } catch (error) {
                    console.log('call error : '+error.code);
                };
            };
            svc_yk('svc.json');
            
            // ê¸°ìƒì²­ ë‚ ì”¨ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            function weather_func_wrap(service_key){
                var xhr = new XMLHttpRequest();
                var url = 'http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst'; /*URL*/
                var queryParams = '?' + encodeURIComponent('serviceKey') + '='+ service_key; /*Service Key*/
                queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /*í˜ì´ì§€ë²ˆí˜¸*/
                queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('500'); /*í•œ í˜ì´ì§€ ê²°ê³¼ ìˆ˜*/
                queryParams += '&' + encodeURIComponent('dataType') + '=' + encodeURIComponent('JSON'); /*ìš”ì²­ìë£Œí˜•ì‹(XML/JSON) Default: XML*/
                queryParams += '&' + encodeURIComponent('base_date') + '=' + encodeURIComponent('20250520'); /*	â€˜ë…„ ì›” ì¼ ë°œí‘œ*/
                queryParams += '&' + encodeURIComponent('base_time') + '=' + encodeURIComponent('0600'); /*06ì‹œ ë°œí‘œ(ì •ì‹œë‹¨ìœ„)*/
                queryParams += '&' + encodeURIComponent('nx') + '=' + encodeURIComponent('55'); /*	ì˜ˆë³´ì§€ì ì˜ X ì¢Œí‘œê°’*/
                queryParams += '&' + encodeURIComponent('ny') + '=' + encodeURIComponent('127'); /*	ì˜ˆë³´ì§€ì ì˜ Y ì¢Œí‘œê°’*/
                xhr.open('GET', url + queryParams);
                xhr.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        // ë‚ ì”¨ë°ì´í„° ê°ì²´

                        // console.log('Status: '+this.status+'nHeaders: '+JSON.stringify(this.getAllResponseHeaders())+'nBody: '+this.responseText);
                        
                       // {"response":{"header":{"resultCode":"00","resultMsg":"NORMAL_SERVICE"},"body":{"dataType":"JSON","items":{"item":[{"baseDate":"20250520","baseTime":"0600","category":"PTY","nx":55,"ny":127,"obsrValue":"0"},{"baseDate":"20250520","baseTime":"0600","category":"REH","nx":55,"ny":127,"obsrValue":"93"},{"baseDate":"20250520","baseTime":"0600","category":"RN1","nx":55,"ny":127,"obsrValue":"0"},{"baseDate":"20250520","baseTime":"0600","category":"T1H","nx":55,"ny":127,"obsrValue":"17.7"},{"baseDate":"20250520","baseTime":"0600","category":"UUU","nx":55,"ny":127,"obsrValue":"0"},{"baseDate":"20250520","baseTime":"0600","category":"VEC","nx":55,"ny":127,"obsrValue":"180"},{"baseDate":"20250520","baseTime":"0600","category":"VVV","nx":55,"ny":127,"obsrValue":"1.6"},{"baseDate":"20250520","baseTime":"0600","category":"WSD","nx":55,"ny":127,"obsrValue":"1.6"}]},"pageNo":1,"numOfRows":500,"totalCount":8}}}

                        // to do
                        console.log("ok");
                    };
                };

                xhr.send('');                     
            };            
        };
    </script>
</body>
</html>
