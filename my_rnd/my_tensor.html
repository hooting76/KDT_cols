<!DOCTYPE html>
<html>
<head>
  <title>날씨 예측 (TensorFlow.js)</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
</head>
<body>
  <h1>날씨 예측 (온도 + 강수확률)</h1>
  <button onclick="trainAndPredict()">학습 및 예측</button>
  <div id="output"></div>

  <script>
    async function trainAndPredict() {
        const res = await fetch('weather_data.json');
        const data = await res.json();

        // 입력: [day, humidity, rainfall, wind]
        const inputs = data.map(d => [d.day, d.humidity, d.rainfall, d.wind]);

        // 출력: [temperature, rain_chance]
        const labels = data.map(d => [d.temperature, d.rain_chance]);

        const inputTensor = tf.tensor2d(inputs);
        const labelTensor = tf.tensor2d(labels);

        // 모델 정의
        const model = tf.sequential();
        model.add(tf.layers.dense({ inputShape: [4], units: 16, activation: 'relu' }));
        model.add(tf.layers.dense({ units: 8, activation: 'relu' }));
        model.add(tf.layers.dense({ units: 2 })); // 출력 2개: temperature, rain_chance

        model.compile({
            optimizer: tf.train.adam(),
            loss: 'meanSquaredError'
        });

        await model.fit(inputTensor, labelTensor, {
            epochs: 200,
            callbacks: {
            onEpochEnd: (epoch, logs) => {
                console.log(`Epoch ${epoch}: loss = ${logs.loss}`);
            }
            }
        });

        // 예측: 예시 입력값
        const testInput = tf.tensor2d([[8, 47, 0.1, 3.0]]);
        const prediction = model.predict(testInput);

        prediction.array().then(result => {
            const [predictedTemp, predictedRainChance] = result[0];
            document.getElementById('output').innerHTML = `
            <p><strong>8일째 예측:</strong></p>
            <p>🌡 온도: ${predictedTemp.toFixed(2)} °C</p>
            <p>🌧 강수확률: ${predictedRainChance.toFixed(2)} %</p>
            `;
        });
    };
    </script>

    <script>
        window.onload = () => {

            // 키 호출
            async function svc_yk(svc){
                try {
                    const res_svc_yk    = await fetch(svc);
                    const data          = await res_svc_yk.text();
                    const svc_yk_data   = await JSON.parse(data);

                    return weather_func_wrap(svc_yk_data[0].key);
                } catch (error) {
                    console.log('call error : '+error.code);
                };
            };
            svc_yk('svc.json');
            
            // 기상청 날씨 데이터 불러오기
            function weather_func_wrap(service_key){
                var xhr = new XMLHttpRequest();
                var url = 'http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst'; /*URL*/
                var queryParams = '?' + encodeURIComponent('serviceKey') + '='+ service_key; /*Service Key*/
                queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /*페이지번호*/
                queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('500'); /*한 페이지 결과 수*/
                queryParams += '&' + encodeURIComponent('dataType') + '=' + encodeURIComponent('JSON'); /*요청자료형식(XML/JSON) Default: XML*/
                queryParams += '&' + encodeURIComponent('base_date') + '=' + encodeURIComponent('20250520'); /*	‘년 월 일 발표*/
                queryParams += '&' + encodeURIComponent('base_time') + '=' + encodeURIComponent('0600'); /*06시 발표(정시단위)*/
                queryParams += '&' + encodeURIComponent('nx') + '=' + encodeURIComponent('55'); /*	예보지점의 X 좌표값*/
                queryParams += '&' + encodeURIComponent('ny') + '=' + encodeURIComponent('127'); /*	예보지점의 Y 좌표값*/
                xhr.open('GET', url + queryParams);
                xhr.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        // 날씨데이터 객체

                        // console.log('Status: '+this.status+'nHeaders: '+JSON.stringify(this.getAllResponseHeaders())+'nBody: '+this.responseText);
                        
                       // {"response":{"header":{"resultCode":"00","resultMsg":"NORMAL_SERVICE"},"body":{"dataType":"JSON","items":{"item":[{"baseDate":"20250520","baseTime":"0600","category":"PTY","nx":55,"ny":127,"obsrValue":"0"},{"baseDate":"20250520","baseTime":"0600","category":"REH","nx":55,"ny":127,"obsrValue":"93"},{"baseDate":"20250520","baseTime":"0600","category":"RN1","nx":55,"ny":127,"obsrValue":"0"},{"baseDate":"20250520","baseTime":"0600","category":"T1H","nx":55,"ny":127,"obsrValue":"17.7"},{"baseDate":"20250520","baseTime":"0600","category":"UUU","nx":55,"ny":127,"obsrValue":"0"},{"baseDate":"20250520","baseTime":"0600","category":"VEC","nx":55,"ny":127,"obsrValue":"180"},{"baseDate":"20250520","baseTime":"0600","category":"VVV","nx":55,"ny":127,"obsrValue":"1.6"},{"baseDate":"20250520","baseTime":"0600","category":"WSD","nx":55,"ny":127,"obsrValue":"1.6"}]},"pageNo":1,"numOfRows":500,"totalCount":8}}}

                        // to do
                        console.log("ok");
                    };
                };

                xhr.send('');                     
            };            
        };
    </script>
</body>
</html>
