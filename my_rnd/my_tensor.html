<!DOCTYPE html>
<html>
<head>
  <title>ë‚ ì”¨ ì˜ˆì¸¡ (TensorFlow.js)</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
</head>
<body>
  <h1>ë‚ ì”¨ ì˜ˆì¸¡ (ì˜¨ë„ + ê°•ìˆ˜í™•ë¥ )</h1>
  <button onclick="trainAndPredict()">í•™ìŠµ ë° ì˜ˆì¸¡</button>
  <div id="output"></div>

  <script>
    async function trainAndPredict() {
        const res = await fetch('weather_data.json');
        const data = await res.json();

        // ì…ë ¥: [day, humidity, rainfall, wind]
        const inputs = data.map(d => [d.day, d.humidity, d.rainfall, d.wind]);

        // ì¶œë ¥: [temperature, rain_chance]
        const labels = data.map(d => [d.temperature, d.rain_chance]);

        const inputTensor = tf.tensor2d(inputs);
        const labelTensor = tf.tensor2d(labels);

        // ëª¨ë¸ ì •ì˜
        const model = tf.sequential();
        model.add(tf.layers.dense({ inputShape: [4], units: 16, activation: 'relu' }));
        model.add(tf.layers.dense({ units: 8, activation: 'relu' }));
        model.add(tf.layers.dense({ units: 2 })); // ì¶œë ¥ 2ê°œ: temperature, rain_chance

        model.compile({
            optimizer: tf.train.adam(),
            loss: 'meanSquaredError'
        });

        await model.fit(inputTensor, labelTensor, {
            epochs: 200,
            callbacks: {
            onEpochEnd: (epoch, logs) => {
                console.log(`Epoch ${epoch}: loss = ${logs.loss}`);
            }
            }
        });

        // ì˜ˆì¸¡: ì˜ˆì‹œ ì…ë ¥ê°’
        const testInput = tf.tensor2d([[8, 47, 0.1, 3.0]]);
        const prediction = model.predict(testInput);

        prediction.array().then(result => {
            const [predictedTemp, predictedRainChance] = result[0];
            document.getElementById('output').innerHTML = `
            <p><strong>8ì¼ì§¸ ì˜ˆì¸¡:</strong></p>
            <p>ğŸŒ¡ ì˜¨ë„: ${predictedTemp.toFixed(2)} Â°C</p>
            <p>ğŸŒ§ ê°•ìˆ˜í™•ë¥ : ${predictedRainChance.toFixed(2)} %</p>
            `;
        });
    };
    </script>

    <script>
        window.onload = () => {

            // í‚¤ í˜¸ì¶œ
            async function svc_yk(svc){
                try {
                    const res_svc_yk    = await fetch(svc);
                    const data          = await res_svc_yk.text();
                    const svc_yk_data   = await JSON.parse(data);

                    return weather_func_wrap(svc_yk_data[0].key);
                } catch (error) {
                    console.log('call error : '+error.code);
                };
            };
            svc_yk('svc.json');
            
            // ê¸°ìƒì²­ ë‚ ì”¨ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            function weather_func_wrap(service_key){
                var xhr = new XMLHttpRequest();
                var url = 'http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst'; /*URL*/
                var queryParams = '?' + encodeURIComponent('serviceKey') + '='+ service_key; /*Service Key*/
                queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('10'); /*í•œ í˜ì´ì§€ ê²°ê³¼ ìˆ˜*/
                queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /*í˜ì´ì§€ë²ˆí˜¸*/
                queryParams += '&' + encodeURIComponent('dataType') + '=' + encodeURIComponent('JSON'); /*ìš”ì²­ìë£Œí˜•ì‹(XML/JSON) Default: XML*/
                queryParams += '&' + encodeURIComponent('base_date') + '=' + encodeURIComponent('20250521'); /*	â€˜ë…„ ì›” ì¼ ë°œí‘œ*/
                queryParams += '&' + encodeURIComponent('base_time') + '=' + encodeURIComponent('0500'); /*06ì‹œ ë°œí‘œ(ì •ì‹œë‹¨ìœ„)*/
                queryParams += '&' + encodeURIComponent('nx') + '=' + encodeURIComponent('55'); /*	ì˜ˆë³´ì§€ì ì˜ X ì¢Œí‘œê°’*/
                queryParams += '&' + encodeURIComponent('ny') + '=' + encodeURIComponent('127'); /*	ì˜ˆë³´ì§€ì ì˜ Y ì¢Œí‘œê°’*/
                xhr.open('GET', url + queryParams);
                xhr.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        // ë‚ ì”¨ë°ì´í„° ê°ì²´
                        const obj_txt = JSON.parse(this.responseText);
                        let obj_info_list = obj_txt.response.body.items.item;
                        
                        obj_info_list.forEach(data => {
                            // console.log(data);
                            switch(data.category){
                                case "TMP" : 
                                    // 1ì‹œê°„ ê¸°ì˜¨ â„ƒ
                                    console.log("í˜„ì¬ ê¸°ì˜¨: "+ data.fcstValue + " â„ƒ");
                                    break;

                                case "UUU" : 
                                    // í’ì†(ë™ì„œì„±ë¶„) m/s
                                    console.log("í’ì†(ë™ì„œì„±ë¶„): " + data.fcstValue + "m/s");
                                    break;

                                case "VVV" : 
                                    // í’ì†(ë‚¨ë¶ì„±ë¶„) m/s
                                    console.log("í’ì†(ë‚¨ë¶ì„±ë¶„): " + data.fcstValue + "m/s");
                                    break;          
                                    
                                case "VEC" : 
                                    // í’í–¥ / deg
                                    // 0 â€“ 45	N-NE	180 â€“ 225	S-SW
                                    // 45 â€“ 90	NE-E	225 â€“ 270	SW-W
                                    // 90 â€“ 135	E-SE	270 â€“ 315	W-NW
                                    // 135 â€“ 180	SE-S	315 â€“ 360	NW-N
                                    let vec_prs = parseInt(data.fcstValue);

                                    function getDirection(vec_prs) {
                                        if (vec_prs < 0 || vec_prs > 360) return "Invalid";

                                        const directions = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
                                        const index = Math.floor(((vec_prs + 22.5) % 360) / 45);
                                        return directions[index];
                                    };

                                    let direct_vec = getDirection(vec_prs);
                                    //console.log(direct_vec);
                                break;                                    
                                    
                                case "WSD" : 
                                    // í’ì†  m/s
                                    console.log("í’ì†: " + data.fcstValue + "m/s");
                                    break;

                                case "SKY" : 
                                    // ë‚ ì”¨ ë§‘ìŒ(1), êµ¬ë¦„ë§ìŒ(3), íë¦¼(4)
                                    let switch_val_sky = parseInt(data.fcstValue);
                                    switch(switch_val_sky){
                                        case 1 : 
                                            console.log("ë‚ ì”¨ : ë§‘ìŒ");
                                            break;
                                        case 3 : 
                                            console.log("ë‚ ì”¨ : êµ¬ë¦„ë§ìŒ");             
                                            break;             
                                        case 4 : 
                                            console.log("ë‚ ì”¨ : íë¦¼");             
                                            break;                   
                                        default :
                                            console.log("ë‚ ì”¨ í˜¸ì¶œ ì˜¤ë¥˜");
                                            break;                             
                                    };
                                break;


                                case "PTY" : 
                                    // ê°•ìˆ˜í˜•íƒœ 
                                    // (ì´ˆë‹¨ê¸°) ì—†ìŒ(0), ë¹„(1), ë¹„/ëˆˆ(2), ëˆˆ(3), ë¹—ë°©ìš¸(5), ë¹—ë°©ìš¸ëˆˆë‚ ë¦¼(6), ëˆˆë‚ ë¦¼(7) 
                                    // (ë‹¨ê¸°) ì—†ìŒ(0), ë¹„(1), ë¹„/ëˆˆ(2), ëˆˆ(3), ì†Œë‚˜ê¸°(4) 

                                    let switch_val_rain_type = parseInt(data.fcstValue);
                                    switch(switch_val_rain_type){
                                        case 0 : 
                                            console.log("ê°•ìˆ˜ í˜•íƒœ : ì—†ìŒ");
                                            break;
                                        case 1 : 
                                            console.log("ê°•ìˆ˜ í˜•íƒœ : ë¹„");      
                                            break;    
                                        case 2 : 
                                            console.log("ê°•ìˆ˜ í˜•íƒœ : ë¹„ í˜¹ì€ ëˆˆ");
                                            break;                            
                                        case 3 : 
                                            console.log("ê°•ìˆ˜ í˜•íƒœ : ëˆˆ");
                                            break;                         
                                        case 4 : 
                                            console.log("ê°•ìˆ˜ í˜•íƒœ : ì†Œë‚˜ê¸°");
                                            break;                                                                                
                                    }
                                break;


                                case "POP" : 
                                    // ê°•ìˆ˜í™•ë¥ , %
                                    if(data.fcstValue == 0){
                                        console.log("ê°•ìˆ˜í™•ë¥ : ì—†ìŒ(0%)");   
                                    }else{
                                        console.log("ê°•ìˆ˜í™•ë¥ : " + data.fcstValue + " %");
                                    }
                                break;          
                   

                                case "WAV" : 
                                    // íŒŒê³ , m
                                    if(0 < data.fcstValue && data.fcstValue > 20){
                                        console.log("íŒŒê³ : " + data.fcstValue + " m");
                                    }else{
                                        console.log("íŒŒê³ : í•´ë‹¹ì—†ìŒ");
                                    }
                                break;        


                                case "PCP" : 
                                    // 1ì‹œê°„ ê°•ìˆ˜ëŸ‰, ë²”ì£¼ (1 mm)
                                    if(data.fcstValue == "ê°•ìˆ˜ì—†ìŒ"){
                                        console.log("ì‹œê°„ë‹¹ ê°•ìˆ˜ëŸ‰: 0 mm");
                                    }else{
                                        console.log("ì‹œê°„ë‹¹ ê°•ìˆ˜ëŸ‰: " + data.fcstValue + "mm");
                                    }
                                break;
                            };
                        });
                    };
                };

                xhr.send('');                     
            };            
        };
    </script>
</body>
</html>
