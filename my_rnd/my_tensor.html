<!DOCTYPE html>
<html>
<head>
  <title>ë‚ ì”¨ ì˜ˆì¸¡ (TensorFlow.js)</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs" ></script>
</head>
<body>
  <h1>ë‹¤ìŒë‚  ë‚ ì”¨ ì˜ˆì¸¡ (ì˜¨ë„ + ê°•ìˆ˜í™•ë¥ )</h1>
  <!-- <button onclick="trainAndPredict()">í•™ìŠµ ë° ì˜ˆì¸¡</button> -->
  <div id="output"></div>

    <script>
        window.onload = () => {

            let today = new Date();
            let year = today.getFullYear();
            let month = ('0' + (today.getMonth() + 1)).slice(-2);
            let day = ('0' + today.getDate()).slice(-2);
            let today_num = year + month + day;
            //console.log(today_num);


            // ğŸ”¶ í•™ìŠµ ë°ì´í„° (ë” ë§ì´ ì¶”ê°€í•´ë„ ì¢‹ìŒ)
            const trainingData = Array.from({ length: 500 }, (_, i) => {
            const day = i % 7;
            const humidity = 40 + Math.random() * 60;
            const rain_drop = Math.random() < 0.5 ? 0 : 1;
            const wind_spd = 1 + Math.random() * 5;

            const temp = 15 + Math.random() * 15; // 15~30ë„
            const rainChance = Math.random() * 100;

            return { day, humidity, rain_drop, wind_spd, temp, rainChance };
            });

            // ğŸ”§ ì „ì²˜ë¦¬ í•¨ìˆ˜
            function preprocessInput(data) {
                return tf.tensor2d(data.map(d => [
                    d.day ?? 0,
                    Number(d.humidity) ?? 0,
                    Number(d.rain_drop) ?? 0,
                    Number(d.wind_spd) ?? 0
                ]));
            }

            function preprocessOutput(data) {
                return tf.tensor2d(data.map(d => [
                    Number(d.temp) / 40,
                    Number(d.rainChance) / 100
                ]));
            }

            function denormalize([tempNorm, rainNorm]) {
                return {
                    temperature: (tempNorm * 40).toFixed(1),
                    rainChance: (rainNorm * 100).toFixed(1)
                };
            }

            // ğŸ“¦ ëª¨ë¸ í•™ìŠµ
            async function trainModel() {
                const xs = preprocessInput(trainingData);
                const ys = preprocessOutput(trainingData);

                const model = tf.sequential();
                model.add(tf.layers.dense({ inputShape: [4], units: 16, activation: 'relu' }));
                model.add(tf.layers.dense({ units: 8, activation: 'relu' }));
                model.add(tf.layers.dense({ units: 2 }));

                model.compile({ loss: 'meanSquaredError', optimizer: 'adam' });
                await model.fit(xs, ys, { epochs: 300, shuffle: true, verbose: 0 });

                return model;
            }

            // ğŸ” ì˜ˆì¸¡ í•¨ìˆ˜
            async function loadModelAndPredict(weather_info_list_arr) {
                const model = await trainModel();

                // ê°ì²´ ë°°ì—´ì„ í‰íƒ„í™”í•˜ì—¬ í•˜ë‚˜ì˜ ê°ì²´ë¡œ ë³€í™˜
                const inputData = [{}];
                weather_info_list_arr.forEach(item => Object.assign(inputData[0], item));

                const inputTensor = preprocessInput(inputData);
                const prediction = model.predict(inputTensor);
                const result = await prediction.array();
                const { temperature, rainChance } = denormalize(result[0]);

                document.getElementById("output").innerHTML = `
                    ${today_num.slice(0,4)}ë…„ ${today_num.slice(4,6)}ì›” ${today_num.slice(6,8)}ì¼
                    <p>ğŸŒ¡ï¸ ì˜ˆì¸¡ ì˜¨ë„: <strong>${temperature} Â°C</strong></p>
                    <p>ğŸŒ§ï¸ ê°•ìˆ˜ í™•ë¥ : <strong>${rainChance} %</strong></p>
                `;
            }

            // í‚¤ í˜¸ì¶œ
            async function svc_yk(svc){
                try {
                    const res_svc_yk    = await fetch(svc);
                    const data          = await res_svc_yk.text();
                    const svc_yk_data   = await JSON.parse(data);

                    return weather_func_wrap(svc_yk_data[0].key);
                } catch (error) {
                    console.log('call error : '+error.code);
                };
            };
            svc_yk('svc.json');
            
            // ê¸°ìƒì²­ ë‚ ì”¨ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            function weather_func_wrap(service_key){
                var xhr = new XMLHttpRequest();
                var url = 'http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst'; /*URL*/
                var queryParams = '?' + encodeURIComponent('serviceKey') + '='+ service_key; /*Service Key*/
                queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('12'); /*í•œ í˜ì´ì§€ ê²°ê³¼ 11 ìˆ˜*/
                queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /*í˜ì´ì§€ë²ˆí˜¸*/
                queryParams += '&' + encodeURIComponent('dataType') + '=' + encodeURIComponent('JSON'); /*ìš”ì²­ìë£Œí˜•ì‹(XML/JSON) Default: XML*/
                queryParams += '&' + encodeURIComponent('base_date') + '=' + encodeURIComponent(today_num); /*	â€˜ë…„ ì›” ì¼ ë°œí‘œ*/
                queryParams += '&' + encodeURIComponent('base_time') + '=' + encodeURIComponent('0500'); /*06ì‹œ ë°œí‘œ(ì •ì‹œë‹¨ìœ„)*/
                queryParams += '&' + encodeURIComponent('nx') + '=' + encodeURIComponent('37'); /*	ì˜ˆë³´ì§€ì ì˜ X ì¢Œí‘œê°’*/
                queryParams += '&' + encodeURIComponent('ny') + '=' + encodeURIComponent('127'); /*	ì˜ˆë³´ì§€ì ì˜ Y ì¢Œí‘œê°’*/
                xhr.open('GET', url + queryParams);
                xhr.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        // ë‚ ì”¨ë°ì´í„° ê°ì²´
                        const obj_txt = JSON.parse(this.responseText);
                        let obj_info_list = obj_txt.response.body.items.item;
                        
                        let weather_info_list_arr = new Array;
                        obj_info_list.forEach(data => {
                            // console.log(data.category);
                            switch(data.category){
                                case "TMP" : 
                                    // 1ì‹œê°„ ê¸°ì˜¨ â„ƒ
                                    // console.log("í˜„ì¬ ê¸°ì˜¨: "+ data.fcstValue + " â„ƒ");
                                    weather_info_list_arr.push({"temp":data.fcstValue});
                                    break;

                                case "UUU" : 
                                    // í’ì†(ë™ì„œì„±ë¶„) m/s
                                    // console.log("í’ì†(ë™ì„œì„±ë¶„): " + data.fcstValue + "m/s");
                                    break;

                                case "VVV" : 
                                    // í’ì†(ë‚¨ë¶ì„±ë¶„) m/s
                                    // console.log("í’ì†(ë‚¨ë¶ì„±ë¶„): " + data.fcstValue + "m/s");
                                    break;          
                                    
                                case "VEC" : 
                                    // í’í–¥ / deg
                                    // 0 â€“ 45	N-NE	180 â€“ 225	S-SW
                                    // 45 â€“ 90	NE-E	225 â€“ 270	SW-W
                                    // 90 â€“ 135	E-SE	270 â€“ 315	W-NW
                                    // 135 â€“ 180	SE-S	315 â€“ 360	NW-N
                                    let vec_prs = parseInt(data.fcstValue);

                                    function getDirection(vec_prs) {
                                        if (vec_prs < 0 || vec_prs > 360) return "Invalid";

                                        const directions = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
                                        const index = Math.floor(((vec_prs + 22.5) % 360) / 45);
                                        return directions[index];
                                    };

                                    let direct_vec = getDirection(vec_prs);
                                    // console.log("í’í–¥ : " + direct_vec + "ë°©í–¥ (ë°©ìœ„: " + vec_prs + "ë„)");

                                    weather_info_list_arr.push({"wind_direction":direct_vec}); //í’í–¥
                                    weather_info_list_arr.push({"wind_deg":data.fcstValue}); //ë°©ìœ„
                                break;                                    
                                    
                                case "WSD" : 
                                    // í’ì†  m/s
                                    // console.log("í’ì†: " + data.fcstValue + "m/s");
                                    weather_info_list_arr.push({"wind_spd":data.fcstValue}); //í’ì†
                                    break;

                                case "SKY" : 
                                    // ë‚ ì”¨ ë§‘ìŒ(1), êµ¬ë¦„ë§ìŒ(3), íë¦¼(4)
                                    let switch_val_sky = parseInt(data.fcstValue);
                                    switch(switch_val_sky){
                                        case 1 : 
                                            // console.log("ë‚ ì”¨ : ë§‘ìŒ");
                                            weather_info_list_arr.push({"sky":"sunny"});
                                            break;
                                        case 3 : 
                                            // console.log("ë‚ ì”¨ : êµ¬ë¦„ë§ìŒ");      
                                            weather_info_list_arr.push({"sky":"sunny_and_cloudy"});
                                            break;             
                                        case 4 : 
                                            // console.log("ë‚ ì”¨ : íë¦¼");
                                            weather_info_list_arr.push({"sky":"cloudy"});
                                            break;                   
                                        default :
                                            // console.log("ë‚ ì”¨ í˜¸ì¶œ ì˜¤ë¥˜");
                                            weather_info_list_arr.push({"sky":null});
                                            break;                             
                                    };
                                break;


                                case "PTY" : 
                                    // ê°•ìˆ˜í˜•íƒœ 
                                    // (ì´ˆë‹¨ê¸°) ì—†ìŒ(0), ë¹„(1), ë¹„/ëˆˆ(2), ëˆˆ(3), ë¹—ë°©ìš¸(5), ë¹—ë°©ìš¸ëˆˆë‚ ë¦¼(6), ëˆˆë‚ ë¦¼(7) 
                                    // (ë‹¨ê¸°) ì—†ìŒ(0), ë¹„(1), ë¹„/ëˆˆ(2), ëˆˆ(3), ì†Œë‚˜ê¸°(4) 

                                    let switch_val_rain_type = parseInt(data.fcstValue);
                                    switch(switch_val_rain_type){
                                        case 0 : 
                                            // console.log("ê°•ìˆ˜ í˜•íƒœ : ì—†ìŒ");
                                            weather_info_list_arr.push({"rain_type":"normal"});
                                            break;
                                        case 1 : 
                                            // console.log("ê°•ìˆ˜ í˜•íƒœ : ë¹„");
                                            weather_info_list_arr.push({"rain_type":"rain"});
                                            break;    
                                        case 2 : 
                                            // console.log("ê°•ìˆ˜ í˜•íƒœ : ë¹„ í˜¹ì€ ëˆˆ");
                                            weather_info_list_arr.push({"rain_type":"rain/snow"});
                                            break;                            
                                        case 3 : 
                                            // console.log("ê°•ìˆ˜ í˜•íƒœ : ëˆˆ");
                                            weather_info_list_arr.push({"rain_type":"snow"});
                                            break;                         
                                        case 4 : 
                                            // console.log("ê°•ìˆ˜ í˜•íƒœ : ì†Œë‚˜ê¸°");
                                            weather_info_list_arr.push({"rain_type":"shower"});
                                            break;                                                                                
                                    };
                                break;


                                case "POP" : 
                                    // ê°•ìˆ˜í™•ë¥ , %
                                    if(data.fcstValue == 0){
                                        // console.log("ê°•ìˆ˜í™•ë¥ : ì—†ìŒ(0%)");   
                                        weather_info_list_arr.push({"rain_perct":0});
                                    }else{
                                        // console.log("ê°•ìˆ˜í™•ë¥ : " + data.fcstValue + " %");
                                        weather_info_list_arr.push({"rain_perct":data.fcstValue});
                                    };
                                break;          
                   

                                case "WAV" : 
                                    // íŒŒê³ , m
                                    if(0 < data.fcstValue && data.fcstValue > 20){
                                        // console.log("íŒŒê³ : " + data.fcstValue + " m");
                                        weather_info_list_arr.push({"wave":data.fcstValue});
                                    }else{
                                        // console.log("íŒŒê³ : í•´ë‹¹ì—†ìŒ");
                                        weather_info_list_arr.push({"wave":0});
                                    };
                                break;        


                                case "PCP" : 
                                    // 1ì‹œê°„ ê°•ìˆ˜ëŸ‰, ë²”ì£¼ (1 mm)
                                    if(data.fcstValue == "ê°•ìˆ˜ì—†ìŒ"){
                                        // console.log("ì‹œê°„ë‹¹ ê°•ìˆ˜ëŸ‰: 0 mm");
                                        weather_info_list_arr.push({"rain_drop":0});
                                    }else{
                                        // console.log("ì‹œê°„ë‹¹ ê°•ìˆ˜ëŸ‰: " + data.fcstValue + "mm");
                                        weather_info_list_arr.push({"rain_drop":data.fcstValue});
                                    };
                                break;

                                case "REH" : 
                                    weather_info_list_arr.push({"humidity":data.fcstValue});
                                break;       
                                
                                default :
                                    let cnt_1 = 1;
                                    weather_info_list_arr.push({"day":cnt_1});
                                    cnt_1++;
                                break;
                            };
                        });
                        // console.log(weather_info_list_arr);
                        loadModelAndPredict(weather_info_list_arr);
                    };
                };
                xhr.send('');                     
            };      
        };
    </script>


</body>
</html>
